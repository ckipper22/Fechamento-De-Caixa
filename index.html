<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fechamento de Caixa — Contagem + Pagamentos</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* A cor de fundo principal e o texto foram mantidos CLAROS/NÃO DARK MODE, conforme sua instrução */
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:#f4f7fb;color:#111827;padding:18px;}
  .card{background:white;border:1px solid #e6edf3;border-radius:12px;padding:16px;box-shadow:0 6px 16px rgba(15,23,42,0.04);}
  .input-field{border:1px solid #e6edf3;border-radius:8px;padding:8px;width:100%;box-sizing:border-box;}
  .small-btn{padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600; font-size: 0.85rem;} 
  .muted{color:#6b7280}
  .denom-row{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #f1f5f9} 
  
  /* Larguras reduzidas para as colunas de Dinheiro */
  .denom-label{width:90px} 
  .denom-input{width:100px} 
  .denom-total{width:90px;text-align:right;font-weight:700; font-size: 0.95rem;} 
  
  /* ESTILO PARA AS NOVAS LINHAS DE PAGAMENTO - UMA LINHA POR MÉTODO */
  .payment-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.95rem;
  }
  .payment-row:last-child {
      border-bottom: none;
  }
  .method-name {
      font-weight: 600;
      color: #1f2937;
      flex-grow: 1;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
  }
  .method-total {
      font-weight: 800;
      color: #111827;
      margin-left: 10px;
      width: 100px; /* Largura fixa para alinhamento */
      text-align: right;
      flex-shrink: 0;
  }
  .method-action {
      margin-left: 8px;
      flex-shrink: 0;
  }

  .value-large{font-weight:800;font-size:1.05rem}
  .no-select{user-select:none}
  textarea.input-field{min-height: 40px; resize: vertical;} 
  
  /* LAYOUT PRINCIPAL: 1.2 parte para Cédulas, 1.2 parte para Moedas, 2.6 partes para Pagamentos */
  .grid-container {
    display: grid;
    grid-template-columns: 1.2fr 1.2fr 2.6fr; 
    gap: 24px;
  }
  .payments-section {
    grid-column: 3 / 4;
  }
  .withdrawals-section {
    grid-column: 1 / 3; 
  }

  /* CLASSES DE CORES */
  .title-green { color: #065f46; } 
  .title-blue { color: #4338ca; } 
  .title-red { color: #991b1b; } 

  @media (max-width:1100px){
      .grid-container{
        grid-template-columns: 1fr 1fr; 
      }
      .payments-section {
        grid-column: 1 / 3;
      }
      .withdrawals-section{
        grid-column: 1 / 3;
      }
  }

  @media (max-width:768px){
    .grid-container{
        grid-template-columns: 1fr;
    }
    .payments-section, .withdrawals-section{
        grid-column: auto;
    }
  }
</style>
</head>
<body>
  <div style="max-width:1200px;margin:0 auto;">

    <div class="card mb-6">
      <h1 style="font-size:20px;color:#4f46e5;font-weight:800">Fechamento de Caixa — Contagem + Pagamentos</h1>
      <p id="currentDate" class="muted mt-1">segunda-feira, --/--/---- às --:--</p>
      <p class="muted text-sm mt-2">Modo moedas: escolha <strong>Quantidade</strong> ou <strong>Pesagem</strong> (g). Em pagamentos/retiradas você pode digitar <code>2+2+3+4</code> ou valores com vírgula.</p>
    </div>

    <div class="grid-container">

      <div class="card">
        <h2 class="font-semibold mb-2">Cédulas</h2>
        <div id="billsContainer">
          </div>
        <div class="mt-4 text-right">
          <div class="muted">Total cédulas:</div>
          <div id="billsTotal" class="value-large">R$ 0,00</div>
        </div>
      </div>

      <div class="card">
        <h2 class="font-semibold mb-2">Moedas — <span id="modeLabel" class="font-bold">Modo: QUANTIDADE</span></h2>
        <p class="muted text-sm">Insira a quantidade ou o peso (g) conforme o modo.</p>
        <div id="coinsContainer" class="mt-3">
          </div>
        <div class="mt-4 flex gap-3">
          <button id="toggleModeBtn" class="small-btn bg-blue-600 text-white">Mudar Modo (QTD / PESAGEM)</button>
          <button id="clearCashBtn" class="small-btn" style="background:#fee2e2;border:1px solid #fca5a5;">Limpar Contagem</button>
        </div>
        <div class="mt-4 text-right">
          <div class="muted">Total moedas:</div>
          <div id="coinsTotal" class="value-large">R$ 0,00</div>
        </div>
      </div>

      <div class="card payments-section">
        <h2 class="font-semibold mb-2">Pagamentos (Cartões / Crediário / PIX)</h2>
        <div id="paymentsContainer">
          </div>

        <div class="mt-4 flex items-center justify-between" style="padding-top: 8px; border-top: 1px solid #e6edf3;">
          <div>
            <div class="muted">Total Pagamentos (não-dinheiro):</div>
            <div id="paymentsTotalDisplay" class="value-large">R$ 0,00</div>
          </div>
          <div class="flex gap-2">
            <button id="clearPaymentsBtn" class="small-btn" style="background:#fee2e2;border:1px solid #fca5a5;">Limpar pagamentos</button>
          </div>
        </div>
      </div>

      <div class="card withdrawals-section">
        <h2 class="font-semibold mb-2">Dinheiro Retirado do Caixa (Sangria/Retirada)</h2>
        <div id="withdrawalsContainer">
           </div>
        
        <div class="mt-4 flex items-center justify-between" style="padding-top: 8px; border-top: 1px solid #e6edf3;">
          <div>
            <div class="muted">Total Retirado:</div>
            <div id="withdrawalsTotalDisplay" class="value-large" style="color:#dc2626">R$ 0,00</div>
          </div>
          <div class="flex gap-2">
            <button id="clearWithdrawalsBtn" class="small-btn" style="background:#fee2e2;border:1px solid #fca5a5;">Limpar Retiradas</button>
          </div>
        </div>
      </div>
      
    </div>

    <div class="card mt-6">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <div style="flex:1;">
          <div class="muted">Total Caixa (cédulas + moedas):</div>
          <div id="cashTotalDisplay" class="value-large">R$ 0,00</div>

          <div class="muted mt-2">Total Pagamentos (Cartões/Crediário/PIX):</div>
          <div id="paymentsTotalFooter" class="value-large">R$ 0,00</div>
          
          <div class="muted mt-2">Dinheiro Retirado:</div>
          <div id="withdrawalsTotalFooter" class="value-large" style="color:#dc2626">R$ 0,00</div>
        </div>

        <div style="width:380px">
          <div class="mt-4 grid grid-cols-2 gap-2">
            <button id="exportCsvBtn" class="small-btn" style="background:#efefef;">Exportar CSV</button>
            <button id="exportTxtBtn" class="small-btn" style="background:#efefef;">Exportar TXT</button>
            <button id="printBtn" class="small-btn bg-green-600 text-white col-span-2">Salvar e Imprimir</button>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

  // ===== Configurações de denominações =====
  const DENOMINATIONS = [
    {value:200.00, label:'R$ 200,00', isCoin:false, weight:0.9},
    {value:100.00, label:'R$ 100,00', isCoin:false, weight:0.9},
    {value:50.00,  label:'R$ 50,00',  isCoin:false, weight:0.9},
    {value:20.00,  label:'R$ 20,00',  isCoin:false, weight:0.9},
    {value:10.00,  label:'R$ 10,00',  isCoin:false, weight:0.9},
    {value:5.00,   label:'R$ 5,00',   isCoin:false, weight:0.9},
    {value:2.00,   label:'R$ 2,00',   isCoin:false, weight:0.9},
    {value:1.00,   label:'R$ 1,00',   isCoin:true,  weight:7.0},
    {value:0.50,   label:'R$ 0,50',   isCoin:true,  weight:6.8},
    {value:0.25,   label:'R$ 0,25',   isCoin:true,  weight:5.7},
    {value:0.10,   label:'R$ 0,10',   isCoin:true,  weight:4.8},
    {value:0.05,   label:'R$ 0,05',   isCoin:true,  weight:3.2},
  ];

  // MÉTODOS DE PAGAMENTO ATUALIZADOS (Inclusão de Aga Único e Aga Parcelado)
  const PAYMENT_METHODS = [
    'Good Card',
    'Depósito em Conta', 
    'Pix Off-line', 
    'Pix Seguro',
    'Visa Débito', 
    'Visa Crédito', 
    'Visa Parcelado',
    'Master Débito', 
    'Master Crédito', 
    'Master Parcelado',
    'Banrisul Débito', 
    'Banrisul A Prazo', 
    'Banrisul Parcelado',
    'Elo Débito', 
    'Elo Crédito', 
    'Elo Parcelado',
    'Aga Único', // NOVO
    'Aga Parcelado', // NOVO
    'Crediário', 
    'Convênio',
    'Reembolsos'
  ];
  
  // Método para Retirada (único)
  const WITHDRAWAL_METHOD = 'Retirada';

  // Estado (Variáveis de Estado)
  let currentMode = localStorage.getItem('cashCounterMode') || 'quantity'; 
  let cashCounts = {}; 
  let payments = {}; 
  let withdrawals = {}; 
  
  // DOM refs
  const billsTotalEl = document.getElementById('billsTotal');
  const coinsTotalEl = document.getElementById('coinsTotal');
  const cashTotalDisplay = document.getElementById('cashTotalDisplay');
  const paymentsContainer = document.getElementById('paymentsContainer');
  const paymentsTotalDisplay = document.getElementById('paymentsTotalDisplay');
  const paymentsTotalFooter = document.getElementById('paymentsTotalFooter');
  const withdrawalsContainer = document.getElementById('withdrawalsContainer');
  const withdrawalsTotalDisplay = document.getElementById('withdrawalsTotalDisplay');
  const withdrawalsTotalFooter = document.getElementById('withdrawalsTotalFooter');
  
  // util
  function cssId(s){ return s.toString().replace(/\./g,'_').replace(/[, ]/g,'').replace(/[^a-zA-Z0-9_\-]/g,''); }
  function fmt(v){ const n = Number(v)||0; return n.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function money(v){ return 'R$ ' + fmt(v); }

  // atualiza data topo
  function updateDate(){ const now = new Date(); const d = now.toLocaleDateString('pt-BR',{weekday:'long', day:'2-digit', month:'2-digit', year:'numeric'}); const h = now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); document.getElementById('currentDate').textContent = `${d} às ${h}`; }
  setInterval(updateDate,1000); updateDate();

  // Função centralizada para atualizar todos os totais e saldos
  function updateAllTotals(){
    let totalPayments = 0;
    PAYMENT_METHODS.forEach(m => { 
        const sum = (payments[m] || []).reduce((s,x)=>s + Number(x.value||0),0);
        totalPayments += sum; 
        // Atualiza a linha compacta do método de pagamento
        const totalEl = document.getElementById(`pay-total-${cssId(m)}`);
        if(totalEl) totalEl.textContent = money(sum);
    });
    
    // Calcula o total de retiradas
    let totalWithdrawals = (withdrawals[WITHDRAWAL_METHOD] || []).reduce((s,x)=>s + Number(x.value||0),0);
    // Atualiza a linha compacta de retirada
    const withdrawalTotalEl = document.getElementById(`pay-total-${cssId(WITHDRAWAL_METHOD)}`);
    if(withdrawalTotalEl) withdrawalTotalEl.textContent = money(totalWithdrawals);


    paymentsTotalDisplay.textContent = money(totalPayments);
    paymentsTotalFooter.textContent = money(totalPayments);
    
    withdrawalsTotalDisplay.textContent = money(totalWithdrawals);
    withdrawalsTotalFooter.textContent = money(totalWithdrawals);

    calculateTotals(); 
  }

  // calcula totais (cédulas e moedas) 
  function calculateTotals(){
    let billsTotal = 0;
    let coinsTotal = 0;
    DENOMINATIONS.forEach(d => {
      const id = cssId(d.value.toFixed(2));
      const inp = document.getElementById(`input-${id}`);
      if(!inp) return;
      let v = parseFloat(inp.value) || 0;
      cashCounts[id] = inp.value;
      
      let total = 0;
      if(d.isCoin && currentMode === 'weight'){
        const weightValue = d.weight > 0 ? d.weight : 1; 
        const qty = v / weightValue; 
        total = qty * d.value;
      } else {
        const qty = Math.round(v);
        total = qty * d.value;
      }
      
      if(d.isCoin) coinsTotal += total; else billsTotal += total;
      document.getElementById(`total-${id}`).textContent = money(total);
    });
    
    localStorage.setItem('cashCounts', JSON.stringify(cashCounts));
    billsTotalEl.textContent = money(billsTotal);
    coinsTotalEl.textContent = money(coinsTotal);
    
    const cashTotal = billsTotal + coinsTotal;
    cashTotalDisplay.textContent = money(cashTotal);
  }

  // render cédulas e moedas
  function renderDenominations(){
    const billsContainer = document.getElementById('billsContainer');
    const coinsContainer = document.getElementById('coinsContainer');
    billsContainer.innerHTML = '';
    coinsContainer.innerHTML = '';
    DENOMINATIONS.forEach(d => {
      const id = cssId(d.value.toFixed(2));
      const row = document.createElement('div');
      row.className = 'denom-row';
      const label = document.createElement('div'); label.className='denom-label'; label.textContent = d.label;
      const inputWrap = document.createElement('div');
      inputWrap.style.flex = '1';
      const initialValue = (cashCounts[id] !== undefined) 
                         ? cashCounts[id] 
                         : (d.isCoin && currentMode==='weight' ? '0.00' : '0');

      inputWrap.innerHTML = `<input id="input-${id}" class="input-field denom-input" type="number" min="0" step="${d.isCoin && currentMode==='weight' ? '0.01' : '1'}" value="${initialValue}" autocomplete="off">`;
      const totalDiv = document.createElement('div'); totalDiv.className='denom-total'; totalDiv.id = `total-${id}`; totalDiv.textContent = money(0);
      row.appendChild(label);
      row.appendChild(inputWrap);
      row.appendChild(totalDiv);
      if(d.isCoin){
        coinsContainer.appendChild(row);
      } else {
        billsContainer.appendChild(row);
      }
      const inp = row.querySelector(`#input-${id}`);
      inp.addEventListener('input', updateAllTotals); 
      inp.addEventListener('blur', ()=>{
        let v = parseFloat(inp.value) || 0;
        if(d.isCoin && currentMode === 'weight') inp.value = v.toFixed(2);
        else inp.value = Math.round(v);
      });
    });
    updateAllTotals(); 
  }

  // clear cash
  document.getElementById('clearCashBtn').addEventListener('click', ()=>{
    if(!confirm('Limpar todas as quantidades de cédulas e moedas?')) return;
    DENOMINATIONS.forEach(d=>{ const id = cssId(d.value.toFixed(2)); const inp = document.getElementById(`input-${id}`); if(inp) inp.value = (d.isCoin && currentMode==='weight') ? '0.00' : '0'; });
    updateAllTotals();
  });

  // toggle modo QTD/PESAGEM
  function updateModeLabel(){ document.getElementById('modeLabel').textContent = (currentMode==='quantity') ? 'Modo: QUANTIDADE' : 'Modo: PESAGEM'; }
  document.getElementById('toggleModeBtn').addEventListener('click', ()=>{
    currentMode = (currentMode==='quantity') ? 'weight' : 'quantity';
    localStorage.setItem('cashCounterMode', currentMode);
    updateModeLabel();
    renderDenominations();
  });
  updateModeLabel();

  // ===== PAGAMENTOS / RETIRADAS (funções reutilizáveis) =====

  // Função Corrigida: Trata operadores pendentes no final da expressão
  function evaluateExpression(expr){
    if(!expr) return 0;
    let safeExpr = expr.replace(/,/g,'.').replace(/\s+/g,'');
    safeExpr = safeExpr.replace(/[+\-*/]+$/,''); 
    if(!safeExpr) return 0; 
    if(!/^[0-9+\-*/().]+$/.test(safeExpr)) throw new Error('inv');
    const fn = new Function('return ('+safeExpr+')');
    const res = fn();
    if(typeof res !== 'number' || !isFinite(res)) throw new Error('inv');
    return Math.round((res + Number.EPSILON) * 100) / 100;
  }
  
  // Função que constrói a UI de lançamento (Pagamentos e Retiradas) - COMPACTA
  function buildEntryUI(method, container, stateVar, labelText, isPayment = true){
    const id = cssId(method);

    let titleClass = '';
    const lowerCaseMethod = method.toLowerCase();
    
    if(isPayment){
        if(lowerCaseMethod.includes('débito') || lowerCaseMethod.includes('pix seguro') || lowerCaseMethod.includes('depósito') || lowerCaseMethod.includes('aga único')){ 
            titleClass = 'title-green'; 
        } else if(lowerCaseMethod.includes('crédito') || lowerCaseMethod.includes('parcelado') || lowerCaseMethod.includes('a prazo') || lowerCaseMethod.includes('crediário') || lowerCaseMethod.includes('aga parcelado')){
            titleClass = 'title-blue'; 
        } else if(lowerCaseMethod.includes('reembolsos')){
             titleClass = 'title-red'; 
        }
    } else {
        titleClass = 'title-red'; 
    }

    const row = document.createElement('div');
    row.className = 'payment-row';
    row.id = `row-${id}`;
    
    // Conteúdo da Linha Única
    row.innerHTML = `
        <span class="method-name ${titleClass}">${labelText}</span>
        <strong id="pay-total-${id}" class="method-total">R$ 0,00</strong>
        <div class="method-action">
            <button id="btn-launch-${id}" class="small-btn bg-blue-500 text-white" style="padding: 4px 8px; font-size: 0.8rem;">Lançar</button>
        </div>
    `;
    container.appendChild(row);

    // Adiciona o Evento ao botão "Lançar"
    document.getElementById(`btn-launch-${id}`).addEventListener('click', (e) => {
        handlePaymentAction(method, stateVar, labelText, isPayment);
    });
    
    // Atualiza o total na linha compacta
    updateAllTotals();
  }
  
  // Função que lida com o lançamento (abre o prompt e processa)
  function handlePaymentAction(method, stateVar, labelText, isPayment){
    // 1. Constrói o histórico/lista de lançamentos para o prompt
    const currentEntries = stateVar[method] || [];
    let initialInput = '';
    if (currentEntries.length > 0) {
        // Se houver histórico, mostra todos os lançamentos para edição/revisão
        initialInput = currentEntries.map(e => e.expr).join(' + ');
        
        // Se a expressão for muito longa, mostra apenas os 3 últimos lançamentos
        if(initialInput.length > 150) {
            initialInput = currentEntries.slice(-3).map(e => e.expr).join(' + ');
            alert(`Para ${labelText}, há muitos lançamentos. O campo de edição abaixo contém apenas os 3 últimos. Para zerar, use o botão "Limpar Pagamentos".`);
        }
    }

    // 2. Abre o prompt para edição (o "espaço para digitar" vira o prompt)
    const actionLabel = isPayment ? 'lançamentos' : 'valores retirados';
    const promptMessage = `Lance ou edite os ${actionLabel} para ${labelText}:\n\nDigite a fórmula completa (ex: 20+10+5,50). Digite 0 para remover todos os lançamentos.\n\nVALOR(ES) ATUAL(IS):`;
    
    const newRaw = prompt(promptMessage, initialInput);

    // 3. Processa a resposta do usuário
    if (newRaw === null) {
        return; // Usuário cancelou
    }

    const trimmedRaw = newRaw.trim();
    
    // Zera os lançamentos se o usuário digitar 0
    if (trimmedRaw === '0') {
        if(confirm(`Tem certeza que deseja remover TODOS os lançamentos de ${labelText}?`)){
            stateVar[method] = [];
        }
    } else if (trimmedRaw === '') {
        // Se o usuário limpou o campo, mas não digitou 0, não faz nada
        return;
    } else {
        // Tenta avaliar a nova expressão completa
        try { 
            let val = evaluateExpression(trimmedRaw);
            
            if(val < 0 && isPayment){
                 alert('O valor do pagamento não pode ser negativo.');
                 return;
            }
            
            if(val === 0 && trimmedRaw !== '0'){
                 alert('A expressão resultou em zero. Não será lançado.');
                 return;
            }

            // A nova entrada é tratada como a soma de TODOS os lançamentos, substituindo a lista anterior
            // A nova lista terá APENAS um item, com o total da expressão.
            // Para manter a granularidade do histórico, vamos tratar cada sinal de '+' como um lançamento
            
            // Esta lógica é complexa. Vamos simplificar para: 
            // O usuário edita a lista inteira, ou adiciona um novo valor.
            
            // Se o usuário digitou uma expressão complexa (ex: "10+20+5"), 
            // vamos considerar essa expressão como o novo único lançamento.
            // Isso evita a complicação de editar itens individuais, focando na simplificação da UI.

            if (trimmedRaw !== initialInput) {
                // Se a nova entrada for diferente da anterior, assumimos que é uma substituição
                if(!confirm(`Isto irá substituir o histórico anterior de ${labelText} pela nova fórmula: ${trimmedRaw}.\n\nDeseja continuar?`)){
                    return;
                }
                
                // Remove todos os lançamentos antigos
                stateVar[method] = [];
                // Adiciona o novo lançamento (que representa o total da expressão digitada)
                stateVar[method].push({ expr: trimmedRaw, value: val });
            }
        
        } catch { 
            alert('Expressão inválida. Use apenas números e operadores + - * / ( )'); 
            return; 
        }
    }
    
    saveState(); 
    updateAllTotals(); // Força a atualização da tela
  }


  // Constrói Pagamentos e Retiradas (função atualizada)
  function buildPaymentsAndWithdrawalsUI(){
      paymentsContainer.innerHTML = ''; 
      PAYMENT_METHODS.forEach(method => buildEntryUI(method, paymentsContainer, payments, method, true));
      
      withdrawalsContainer.innerHTML = ''; 
      buildEntryUI(WITHDRAWAL_METHOD, withdrawalsContainer, withdrawals, 'Valor Retirado (Sangria)', false);
      
      updateAllTotals();
  }

  // Limpar Pagamentos
  document.getElementById('clearPaymentsBtn').addEventListener('click', ()=>{
    if(!confirm('Apagar TODOS os pagamentos?')) return;
    PAYMENT_METHODS.forEach(m => payments[m] = []); 
    saveState(); buildPaymentsAndWithdrawalsUI(); updateAllTotals();
  });
  
  // Limpar Retiradas
  document.getElementById('clearWithdrawalsBtn').addEventListener('click', ()=>{
    if(!confirm('Apagar TODAS as retiradas de caixa?')) return;
    withdrawals[WITHDRAWAL_METHOD] = [];
    saveState(); buildPaymentsAndWithdrawalsUI(); updateAllTotals();
  });

  // Salva todos os estados
  function saveState(){ 
      localStorage.setItem('payments_v5', JSON.stringify(payments)); // Nova versão do storage
      localStorage.setItem('cashCounts', JSON.stringify(cashCounts)); 
      localStorage.setItem('withdrawals_v2', JSON.stringify(withdrawals)); // Nova versão do storage
  }
  
  // Função para carregar o estado inicial (garante que NÃO ZERE os valores)
  function loadInitialState(){
      // Tenta carregar dados do localStorage
      try {
          const storedCash = localStorage.getItem('cashCounts');
          if (storedCash) cashCounts = JSON.parse(storedCash);
      } catch (e) { console.error('Erro ao carregar cashCounts:', e); }

      try {
          // Tenta carregar a nova versão, ou a anterior se a nova não existir
          const storedPayments = localStorage.getItem('payments_v5') || localStorage.getItem('payments_v4'); 
          if (storedPayments) payments = JSON.parse(storedPayments);
      } catch (e) { console.error('Erro ao carregar payments_v5/v4:', e); }

      try {
          const storedWithdrawals = localStorage.getItem('withdrawals_v2') || localStorage.getItem('withdrawals_v1');
          if (storedWithdrawals) withdrawals = JSON.parse(storedWithdrawals);
      } catch (e) { console.error('Erro ao carregar withdrawals_v2/v1:', e); }

      // Garante que todos os métodos de pagamento/retirada listados existam no objeto de estado
      PAYMENT_METHODS.forEach(m => { if (!Array.isArray(payments[m])) payments[m] = []; });
      if (!Array.isArray(withdrawals[WITHDRAWAL_METHOD])) withdrawals[WITHDRAWAL_METHOD] = [];

      // Renderiza a UI com os dados carregados
      renderDenominations();
      buildPaymentsAndWithdrawalsUI();
      updateAllTotals();
  }

  // ===== Relatórios / Export / Impressão (Otimizada) =====
  function generateReport(){
    // caixa
    let billsTotal = 0, coinsTotal = 0;
    const cashDetails = [];
    DENOMINATIONS.forEach(d => {
      const id = cssId(d.value.toFixed(2));
      // Pega o valor atual da tela (importante para impressão sem zerar)
      const raw = document.getElementById(`input-${id}`)?.value || 0;
      const val = parseFloat(raw) || 0;
      let total = 0;
      if(d.isCoin && currentMode === 'weight'){
        const weightValue = d.weight > 0 ? d.weight : 1; 
        const qty = val / weightValue;
        total = qty * d.value;
      } else {
        const qty = Math.round(val);
        total = qty * d.value;
      }
      if(d.isCoin) coinsTotal += total; else billsTotal += total;
      cashDetails.push({name:d.label, input: raw, total});
    });

    // pagamentos
    const payDetails = [];
    let paymentsTotal = 0;
    PAYMENT_METHODS.forEach(m => {
      const arr = payments[m] || [];
      const sum = arr.reduce((s,x)=>s+Number(x.value||0),0);
      paymentsTotal += sum;
      payDetails.push({method:m, items: arr.slice(), total: sum});
    });

    // retiradas
    const withdrawalDetails = [];
    let withdrawalsTotal = (withdrawals[WITHDRAWAL_METHOD] || []).reduce((s,x)=>s + Number(x.value||0),0);
    withdrawalDetails.push({method: WITHDRAWAL_METHOD, items: (withdrawals[WITHDRAWAL_METHOD] || []).slice(), total: withdrawalsTotal});


    const cashTotal = billsTotal + coinsTotal;
    const grandTotal = cashTotal + paymentsTotal; 

    return { cashDetails, billsTotal, coinsTotal, cashTotal, withdrawalsTotal, withdrawalDetails, paymentsTotal, payDetails, grandTotal };
  }

  // Export TXT (Mantido)
  document.getElementById('exportTxtBtn').addEventListener('click', ()=>{
    const r = generateReport();
    let txt = `FECHAMENTO DE CAIXA\n${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}\n`;
    
    // Contagem de Dinheiro
    txt += `\n--- DINHEIRO ---\n`;
    r.cashDetails.forEach(d => {
      if(Number(d.total) > 0) txt += `${d.name} (${d.input}) = ${money(d.total)}\n`;
    });
    txt += `\nTOTAL DINHEIRO: ${money(r.cashTotal)}\n`;
    
    // Pagamentos
    txt += `\n--- PAGAMENTOS ---\n`;
    r.payDetails.forEach(p => {
      if(p.total === 0) return;
      txt += `${p.method}: ${money(p.total)}\n`;
      p.items.forEach((it, idx) => txt += `  -> ${it.expr} = ${money(it.value)}\n`);
    });
    txt += `\nTOTAL PAGAMENTOS: ${money(r.paymentsTotal)}\n`;

    // Retiradas
    txt += `\n--- RETIRADAS ---\n`;
    if(r.withdrawalsTotal > 0){
        r.withdrawalDetails[0].items.forEach((it, idx) => txt += `  -> ${it.expr} = ${money(it.value)}\n`);
    } else {
        txt += 'Nenhuma retirada.\n';
    }
    txt += `TOTAL RETIRADO: ${money(r.withdrawalsTotal)}\n`;
    
    // Total Geral
    txt += `\n----------------\n`;
    txt += `TOTAL CAIXA (Dinheiro + Pagamentos): ${money(r.cashTotal + r.paymentsTotal)}\n`;
    
    const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `fechamento_${new Date().toISOString().slice(0,10)}.txt`; a.click();
  });

  // Export CSV (Mantido)
  document.getElementById('exportCsvBtn').addEventListener('click', ()=>{
    const r = generateReport();
    const lines = ['Tipo;Detalhe;Valor'];
    r.cashDetails.forEach(d => {
      if(Number(d.total) > 0) lines.push(`Dinheiro;"${d.name} (entrada: ${d.input})";"${d.total.toFixed(2).replace('.',',')}"`);
    });
    r.payDetails.forEach(p => {
      p.items.forEach(it => {
        const expr = (it.expr||'').replace(/"/g,'""');
        lines.push(`Pagamento;"${p.method} - ${expr}";"${it.value.toFixed(2).replace('.',',')}"`);
      });
    });
    
    r.withdrawalDetails[0].items.forEach(it => {
        const expr = (it.expr||'').replace(/"/g,'""');
        lines.push(`Retirada;"${WITHDRAWAL_METHOD} - ${expr}";"${(-it.value).toFixed(2).replace('.',',')}"`);
    });
    
    lines.push(`TOTAL DINHEIRO EM CAIXA;;"${r.cashTotal.toFixed(2).replace('.',',')}"`);
    lines.push(`TOTAL PAGAMENTOS;;"${r.paymentsTotal.toFixed(2).replace('.',',')}"`);
    lines.push(`TOTAL RETIRADO;;"${r.withdrawalsTotal.toFixed(2).replace('.',',')}"`);
    
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `fechamento_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  });

  // Impressão (Otimizada e Aprimorada)
  document.getElementById('printBtn').addEventListener('click', ()=>{
    saveState(); // Salva o estado antes de imprimir
    const r = generateReport();
    
    // Conteúdo formatado para impressão térmica compacta e em negrito forte
    let printContent = ''; 
    
    // Título e Data/Hora
    printContent += `<center><strong>FECHAMENTO DE CAIXA</strong></center>\n`;
    printContent += `<center>${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}</center>\n`;
    printContent += `--------------------------------\n`; // 32 caracteres
    
    // CONTAGEM DE DINHEIRO
    printContent += `<strong>DINHEIRO EM CAIXA</strong>\n`;
    let foundCash = false;
    r.cashDetails.forEach(d => {
      if(Number(d.total) > 0) {
          // Compactação: nome (input) = valor (em negrito)
          printContent += `${d.name.padEnd(14).slice(0,14)} (${String(d.input).padStart(4)}) = <strong>${money(d.total)}</strong>\n`;
          foundCash = true;
      }
    });
    if(!foundCash) printContent += `Nenhuma contagem de dinheiro.\n`;
    printContent += `TOTAL DINHEIRO: <strong>${money(r.cashTotal)}</strong>\n`;
    printContent += `--------------------------------\n`;

    // PAGAMENTOS (NÃO-DINHEIRO)
    printContent += `<strong>PAGAMENTOS (EXTERNOS)</strong>\n`;
    let foundPayments = false;
    r.payDetails.forEach(p => {
      if(p.total > 0) {
        // Cabeçalho do método + Total (em negrito)
        printContent += `${p.method.toUpperCase().slice(0,20)}: <strong>${money(p.total)}</strong>\n`;
        // Detalhes da entrada (apenas a expressão e valor em negrito)
        p.items.forEach((it, idx) => printContent += `  > ${it.expr} = <strong>${money(it.value)}</strong>\n`);
        foundPayments = true;
      }
    });
    if(!foundPayments) printContent += `Nenhum pagamento registrado.\n`;
    printContent += `TOTAL PAGAMENTOS: <strong>${money(r.paymentsTotal)}</strong>\n`;
    printContent += `--------------------------------\n`;

    // RETIRADA
    printContent += `<strong>RETIRADA DE CAIXA</strong>\n`;
    if(r.withdrawalsTotal > 0){
        r.withdrawalDetails[0].items.forEach((it, idx) => printContent += `  > ${it.expr} = <strong>${money(it.value)}</strong>\n`);
    } else {
        printContent += `Nenhuma retirada registrada.\n`;
    }
    printContent += `TOTAL RETIRADO: <strong>${money(r.withdrawalsTotal)}</strong>\n`;
    printContent += `--------------------------------\n`;

    // TOTAIS FINAIS
    printContent += `<strong>TOTAL CAIXA (SOMA GERAL):</strong>\n`;
    printContent += `<strong>${money(r.cashTotal + r.paymentsTotal)}</strong>\n`;
    printContent += `--------------------------------\n`;

    // Adiciona algumas linhas vazias no final (para dar um pequeno avanço no papel)
    printContent += '\n\n.'; 
    
    // Prepara o HTML da janela de impressão
    const outHtml = '<pre style="font-family:monospace; color: black; line-height: 1.0; font-weight: bold; margin: 0; padding: 0;">' + printContent + '</pre>';
    
    const w = window.open('','_blank','width=400,height=600');
    // CSS para zerar margens e garantir a impressão em preto (evitar dark mode/economia de tinta)
    w.document.write(`
      <html>
      <head>
        <title>Relatório de Caixa</title>
        <style>
          @media print { 
            body { 
              color: black !important; 
              background-color: white !important; 
              -webkit-print-color-adjust: exact; 
              print-color-adjust: exact; 
              /* Zera as margens da página */
              margin: 0; 
              padding: 0;
              /* Define um tamanho de fonte menor para economia */
              font-size: 10pt;
            } 
            pre { 
              color: black !important; 
              margin: 0; /* Zera margem do PRE */
              padding: 0;
              line-height: 1.1; /* Reduz o espaçamento entre linhas (econimiza papel) */
              white-space: pre-wrap; /* Permite quebras de linha longas */
              /* Garante que o negrito funcione na impressão */
              font-weight: bold !important; 
            } 
            /* Garante que o elemento strong e b sejam impressos em negrito */
            strong, b { font-weight: bolder !important; }
          }
        </style>
      </head>
      <body>
      ${outHtml}
      </body>
      </html>
    `);
    w.document.close(); 
    w.print();
  });

  // AÇÕES DE INICIALIZAÇÃO
  loadInitialState();

  // salvar pagamentos e retiradas antes de sair
  window.addEventListener('beforeunload', saveState);

});
</script>
</body>
</html>
