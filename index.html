<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fechamento de Caixa — Contagem + Pagamentos</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:#f4f7fb;color:#111827;padding:18px;}
  .card{background:white;border:1px solid #e6edf3;border-radius:12px;padding:16px;box-shadow:0 6px 16px rgba(15,23,42,0.04);}
  .input-field{border:1px solid #e6edf3;border-radius:8px;padding:8px;width:100%;box-sizing:border-box;}
  .small-btn{padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600; font-size: 0.85rem;} 
  .muted{color:#6b7280}
  .denom-row{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #f1f5f9} 
  
  /* Larguras reduzidas para as colunas de Dinheiro */
  .denom-label{width:90px} 
  .denom-input{width:100px} 
  .denom-total{width:90px;text-align:right;font-weight:700; font-size: 0.95rem;} 
  
  .payments-list{max-height:180px;overflow:auto;margin-top:10px}
  .payment-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#fafbff;border:1px solid #eef2ff;margin-bottom:8px}
  .value-large{font-weight:800;font-size:1.05rem}
  .no-select{user-select:none}
  textarea.input-field{min-height:60px; resize: vertical;} 
  
  /* LAYOUT PRINCIPAL: 1.2 parte para Cédulas, 1.2 parte para Moedas, 2.6 partes para Pagamentos */
  .grid-container {
    display: grid;
    grid-template-columns: 1.2fr 1.2fr 2.6fr; 
    gap: 24px;
  }
  .payments-section {
    grid-column: 3 / 4;
  }
  .withdrawals-section {
    grid-column: 1 / 3; 
  }

  /* Novo estilo para o título do método de pagamento/retirada */
  .method-title {
    font-weight: 800; 
    font-size: 1.1rem; 
    color: #1f2937; 
    padding: 4px 8px; 
    border-radius: 4px;
    background-color: #f3f4f6; 
    display: inline-block; 
  }

  /* Classes para destaque de cor */
  .title-green { background-color: #d1fae5; color: #065f46; } 
  .title-blue { background-color: #e0e7ff; color: #4338ca; } 
  .title-red { background-color: #fee2e2; color: #991b1b; } 


  @media (max-width:1100px){
      .grid-container{
        grid-template-columns: 1fr 1fr; 
      }
      .payments-section {
        grid-column: 1 / 3;
      }
      .withdrawals-section{
        grid-column: 1 / 3;
      }
  }

  @media (max-width:768px){
    .grid-container{
        grid-template-columns: 1fr;
    }
    .payments-section, .withdrawals-section{
        grid-column: auto;
    }
  }
</style>
</head>
<body>
  <div style="max-width:1200px;margin:0 auto;">

    <div class="card mb-6">
      <h1 style="font-size:20px;color:#4f46e5;font-weight:800">Fechamento de Caixa — Contagem + Pagamentos</h1>
      <p id="currentDate" class="muted mt-1">segunda-feira, --/--/---- às --:--</p>
      <p class="muted text-sm mt-2">Modo moedas: escolha <strong>Quantidade</strong> ou <strong>Pesagem</strong> (g). Em pagamentos/retiradas você pode digitar <code>2+2+3+4</code> ou valores com vírgula.</p>
    </div>

    <div class="grid-container">

      <div class="card">
        <h2 class="font-semibold mb-2">Cédulas</h2>
        <div id="billsContainer">
          </div>
        <div class="mt-4 text-right">
          <div class="muted">Total cédulas:</div>
          <div id="billsTotal" class="value-large">R$ 0,00</div>
        </div>
      </div>

      <div class="card">
        <h2 class="font-semibold mb-2">Moedas — <span id="modeLabel" class="font-bold">Modo: QUANTIDADE</span></h2>
        <p class="muted text-sm">Insira a quantidade ou o peso (g) conforme o modo.</p>
        <div id="coinsContainer" class="mt-3">
          </div>
        <div class="mt-4 flex gap-3">
          <button id="toggleModeBtn" class="small-btn bg-blue-600 text-white">Mudar Modo (QTD / PESAGEM)</button>
          <button id="clearCashBtn" class="small-btn" style="background:#fee2e2;border:1px solid #fca5a5;">Limpar Contagem</button>
        </div>
        <div class="mt-4 text-right">
          <div class="muted">Total moedas:</div>
          <div id="coinsTotal" class="value-large">R$ 0,00</div>
        </div>
      </div>

      <div class="card payments-section">
        <h2 class="font-semibold mb-2">Pagamentos (Cartões / Crediário / PIX)</h2>
        <div id="paymentsContainer" style="max-height:480px;overflow:auto;">
          </div>

        <div class="mt-4 flex items-center justify-between">
          <div>
            <div class="muted">Total Pagamentos (não-dinheiro):</div>
            <div id="paymentsTotalDisplay" class="value-large">R$ 0,00</div>
          </div>
          <div class="flex gap-2">
            <button id="clearPaymentsBtn" class="small-btn" style="background:#fee2e2;border:1px solid #fca5a5;">Limpar pagamentos</button>
          </div>
        </div>
      </div>

      <div class="card withdrawals-section">
        <h2 class="font-semibold mb-2">Dinheiro Retirado do Caixa (Sangria/Retirada)</h2>
        <div id="withdrawalsContainer" style="max-height:220px;overflow:auto;">
          </div>
        
        <div class="mt-4 flex items-center justify-between">
          <div>
            <div class="muted">Total Retirado:</div>
            <div id="withdrawalsTotalDisplay" class="value-large" style="color:#dc2626">R$ 0,00</div>
          </div>
          <div class="flex gap-2">
            <button id="clearWithdrawalsBtn" class="small-btn" style="background:#fee2e2;border:1px solid #fca5a5;">Limpar Retiradas</button>
          </div>
        </div>
      </div>
      
    </div>

    <div class="card mt-6">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <div style="flex:1;">
          <div class="muted">Total Caixa (cédulas + moedas):</div>
          <div id="cashTotalDisplay" class="value-large">R$ 0,00</div>

          <div class="muted mt-2">Total Pagamentos (Cartões/Crediário/PIX):</div>
          <div id="paymentsTotalFooter" class="value-large">R$ 0,00</div>
          
          <div class="muted mt-2">Dinheiro Retirado:</div>
          <div id="withdrawalsTotalFooter" class="value-large" style="color:#dc2626">R$ 0,00</div>
        </div>

        <div style="width:380px">
          <div class="mt-4 grid grid-cols-2 gap-2">
            <button id="exportCsvBtn" class="small-btn" style="background:#efefef;">Exportar CSV</button>
            <button id="exportTxtBtn" class="small-btn" style="background:#efefef;">Exportar TXT</button>
            <button id="printBtn" class="small-btn bg-green-600 text-white col-span-2">Salvar e Imprimir</button>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

  // ===== Configurações de denominações =====
  const DENOMINATIONS = [
    {value:200.00, label:'R$ 200,00', isCoin:false, weight:0.9},
    {value:100.00, label:'R$ 100,00', isCoin:false, weight:0.9},
    {value:50.00,  label:'R$ 50,00',  isCoin:false, weight:0.9},
    {value:20.00,  label:'R$ 20,00',  isCoin:false, weight:0.9},
    {value:10.00,  label:'R$ 10,00',  isCoin:false, weight:0.9},
    {value:5.00,   label:'R$ 5,00',   isCoin:false, weight:0.9},
    {value:2.00,   label:'R$ 2,00',   isCoin:false, weight:0.9},
    {value:1.00,   label:'R$ 1,00',   isCoin:true,  weight:7.0},
    {value:0.50,   label:'R$ 0,50',   isCoin:true,  weight:6.8},
    {value:0.25,   label:'R$ 0,25',   isCoin:true,  weight:5.7},
    {value:0.10,   label:'R$ 0,10',   isCoin:true,  weight:4.8},
    {value:0.05,   label:'R$ 0,05',   isCoin:true,  weight:3.2},
  ];

  // MÉTODOS DE PAGAMENTO ATUALIZADOS - ORDEM SOLICITADA PELO USUÁRIO
  const PAYMENT_METHODS = [
    'Good Card',
    'Depósito em Conta', 
    'Pix Off-line', 
    'Pix Seguro',
    'Visa Débito', 
    'Visa Crédito', 
    'Visa Parcelado',
    'Master Débito', 
    'Master Crédito', 
    'Master Parcelado',
    'Banrisul Débito', // 'Banrisul À Vista' mudado para 'Banrisul Débito'
    'Banrisul A Prazo', 
    'Banrisul Parcelado',
    'Elo Débito', 
    'Elo Crédito', 
    'Elo Parcelado',
    'Crediário', 
    'Convênio',
    'Reembolsos' // Adicionado Reembolsos
  ];
  
  // Método para Retirada (único)
  const WITHDRAWAL_METHOD = 'Retirada';

  // Estado (Variáveis de Estado)
  let currentMode = localStorage.getItem('cashCounterMode') || 'quantity'; 
  let cashCounts = {}; 
  let payments = {}; 
  let withdrawals = {}; 
  
  // DOM refs
  const billsContainer = document.getElementById('billsContainer');
  const coinsContainer = document.getElementById('coinsContainer');
  const modeLabel = document.getElementById('modeLabel');
  const billsTotalEl = document.getElementById('billsTotal');
  const coinsTotalEl = document.getElementById('coinsTotal');
  const cashTotalDisplay = document.getElementById('cashTotalDisplay');
  const paymentsContainer = document.getElementById('paymentsContainer');
  const paymentsTotalDisplay = document.getElementById('paymentsTotalDisplay');
  const paymentsTotalFooter = document.getElementById('paymentsTotalFooter');
  const withdrawalsContainer = document.getElementById('withdrawalsContainer');
  const withdrawalsTotalDisplay = document.getElementById('withdrawalsTotalDisplay');
  const withdrawalsTotalFooter = document.getElementById('withdrawalsTotalFooter');
  const clearWithdrawalsBtn = document.getElementById('clearWithdrawalsBtn');

  // util
  function cssId(s){ return s.toString().replace(/\./g,'_').replace(/[, ]/g,'').replace(/[^a-zA-Z0-9_\-]/g,''); }
  function fmt(v){ const n = Number(v)||0; return n.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function money(v){ return 'R$ ' + fmt(v); }

  // atualiza data topo
  function updateDate(){ const now = new Date(); const d = now.toLocaleDateString('pt-BR',{weekday:'long', day:'2-digit', month:'2-digit', year:'numeric'}); const h = now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); document.getElementById('currentDate').textContent = `${d} às ${h}`; }
  setInterval(updateDate,1000); updateDate();

  // Função centralizada para atualizar todos os totais e saldos
  function updateAllTotals(){
    let totalPayments = 0;
    PAYMENT_METHODS.forEach(m => { totalPayments += (payments[m] || []).reduce((s,x)=>s + Number(x.value||0),0); });
    
    // Calcula o total de retiradas
    let totalWithdrawals = (withdrawals[WITHDRAWAL_METHOD] || []).reduce((s,x)=>s + Number(x.value||0),0);

    paymentsTotalDisplay.textContent = money(totalPayments);
    paymentsTotalFooter.textContent = money(totalPayments);
    
    withdrawalsTotalDisplay.textContent = money(totalWithdrawals);
    withdrawalsTotalFooter.textContent = money(totalWithdrawals);

    calculateTotals(); 
  }

  // calcula totais (cédulas e moedas) 
  function calculateTotals(){
    let billsTotal = 0;
    let coinsTotal = 0;
    DENOMINATIONS.forEach(d => {
      const id = cssId(d.value.toFixed(2));
      const inp = document.getElementById(`input-${id}`);
      if(!inp) return;
      let v = parseFloat(inp.value) || 0;
      cashCounts[id] = inp.value;
      
      let total = 0;
      if(d.isCoin && currentMode === 'weight'){
        const weightValue = d.weight > 0 ? d.weight : 1; 
        const qty = v / weightValue; 
        total = qty * d.value;
      } else {
        const qty = Math.round(v);
        total = qty * d.value;
      }
      
      if(d.isCoin) coinsTotal += total; else billsTotal += total;
      document.getElementById(`total-${id}`).textContent = money(total);
    });
    
    localStorage.setItem('cashCounts', JSON.stringify(cashCounts));
    billsTotalEl.textContent = money(billsTotal);
    coinsTotalEl.textContent = money(coinsTotal);
    
    const cashTotal = billsTotal + coinsTotal;
    cashTotalDisplay.textContent = money(cashTotal);

    // Saldo Final (antigo) foi removido
  }

  // render cédulas e moedas
  function renderDenominations(){
    billsContainer.innerHTML = '';
    coinsContainer.innerHTML = '';
    DENOMINATIONS.forEach(d => {
      const id = cssId(d.value.toFixed(2));
      const row = document.createElement('div');
      row.className = 'denom-row';
      const label = document.createElement('div'); label.className='denom-label'; label.textContent = d.label;
      const inputWrap = document.createElement('div');
      inputWrap.style.flex = '1';
      const initialValue = (cashCounts[id] !== undefined) 
                         ? cashCounts[id] 
                         : (d.isCoin && currentMode==='weight' ? '0.00' : '0');

      inputWrap.innerHTML = `<input id="input-${id}" class="input-field denom-input" type="number" min="0" step="${d.isCoin && currentMode==='weight' ? '0.01' : '1'}" value="${initialValue}" autocomplete="off">`;
      const totalDiv = document.createElement('div'); totalDiv.className='denom-total'; totalDiv.id = `total-${id}`; totalDiv.textContent = money(0);
      row.appendChild(label);
      row.appendChild(inputWrap);
      row.appendChild(totalDiv);
      if(d.isCoin){
        coinsContainer.appendChild(row);
      } else {
        billsContainer.appendChild(row);
      }
      const inp = row.querySelector(`#input-${id}`);
      inp.addEventListener('input', updateAllTotals); 
      inp.addEventListener('blur', ()=>{
        let v = parseFloat(inp.value) || 0;
        if(d.isCoin && currentMode === 'weight') inp.value = v.toFixed(2);
        else inp.value = Math.round(v);
      });
    });
    updateAllTotals(); 
  }

  // clear cash
  document.getElementById('clearCashBtn').addEventListener('click', ()=>{
    if(!confirm('Limpar todas as quantidades de cédulas e moedas?')) return;
    DENOMINATIONS.forEach(d=>{ const id = cssId(d.value.toFixed(2)); const inp = document.getElementById(`input-${id}`); if(inp) inp.value = (d.isCoin && currentMode==='weight') ? '0.00' : '0'; });
    updateAllTotals();
  });

  // toggle modo QTD/PESAGEM
  function updateModeLabel(){ modeLabel.textContent = (currentMode==='quantity') ? 'Modo: QUANTIDADE' : 'Modo: PESAGEM'; }
  document.getElementById('toggleModeBtn').addEventListener('click', ()=>{
    currentMode = (currentMode==='quantity') ? 'weight' : 'quantity';
    localStorage.setItem('cashCounterMode', currentMode);
    updateModeLabel();
    renderDenominations();
  });
  updateModeLabel();

  // ===== PAGAMENTOS / RETIRADAS (funções reutilizáveis) =====

  // Função Corrigida: Trata operadores pendentes no final da expressão
  function evaluateExpression(expr){
    if(!expr) return 0;
    let safeExpr = expr.replace(/,/g,'.').replace(/\s+/g,'');
    safeExpr = safeExpr.replace(/[+\-*/]+$/,''); 
    if(!safeExpr) return 0; 
    if(!/^[0-9+\-*/().]+$/.test(safeExpr)) throw new Error('inv');
    const fn = new Function('return ('+safeExpr+')');
    const res = fn();
    if(typeof res !== 'number' || !isFinite(res)) throw new Error('inv');
    return Math.round((res + Number.EPSILON) * 100) / 100;
  }
  
  // Função que constrói a UI de lançamento (Pagamentos e Retiradas)
  function buildEntryUI(method, container, stateVar, labelText, isPayment = true){
    const id = cssId(method);

    let titleClass = '';
    const lowerCaseMethod = method.toLowerCase();
    
    if(isPayment){
        if(lowerCaseMethod.includes('débito') || lowerCaseMethod.includes('pix seguro') || lowerCaseMethod.includes('depósito')){
            titleClass = 'title-green'; // Débito, Pix Seguro e Depósito (Recebimento Imediato)
        } else if(lowerCaseMethod.includes('crédito') || lowerCaseMethod.includes('parcelado') || lowerCaseMethod.includes('a prazo') || lowerCaseMethod.includes('crediário')){
            titleClass = 'title-blue'; // Crédito, Parcelado, A Prazo, Crediário (Recebimento Futuro)
        } else if(lowerCaseMethod.includes('reembolsos')){
             titleClass = 'title-red'; // Reembolsos são saídas de caixa
        }
        // Outros (Good Card, Convênio, Pix Off-line) ficam com o fundo cinza padrão
    } else {
        titleClass = 'title-red'; // Retirada (Saída de Caixa)
    }

    const wrapper = document.createElement('div');
    wrapper.className = 'card mb-4';
    wrapper.style.padding = '12px';
    
    wrapper.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
        <div style="flex:1;">
          <label class="method-title ${titleClass}">${labelText}</label>
          <textarea id="pay-input-${id}" class="input-field" placeholder="ex: 10,50 + 2 + 3 + 4 + 5" style="margin-top:8px;" autocomplete="off"></textarea>
          <div class="muted" style="margin-top:8px">Resultado Atual: <span id="pay-current-${id}" class="value-large">R$ 0,00</span></div>
        </div>
        <div style="width:170px;text-align:right;">
          <div class="muted">Total Acumulado:</div>
          <div id="pay-total-${id}" class="value-large">R$ 0,00</div>
        </div>
      </div>
      <div id="pay-list-${id}" class="payments-list" style="margin-top:10px"></div>
    `;
    container.appendChild(wrapper);

    const inp = document.getElementById(`pay-input-${id}`);
    const cur = document.getElementById(`pay-current-${id}`);
    
    // Atualização em tempo real (on input)
    inp.addEventListener('input', ()=> {
      try{ 
          const v = evaluateExpression(inp.value); 
          cur.textContent = money(v); 
      } catch (e) { 
          if (e.message === 'inv') cur.textContent = 'Inválido';
      }
    });

    // Adiciona o lançamento no BLUR (perda de foco)
    inp.addEventListener('blur', () => {
        addEntry(method, stateVar);
    });

    // Adiciona o lançamento no ENTER
    inp.addEventListener('keydown', ev => {
      if(ev.key === 'Enter'){ 
        ev.preventDefault(); 
        addEntry(method, stateVar); 
      }
    });
    
    renderEntryList(method, stateVar, isPayment);
  }

  // Função que adiciona o lançamento
  function addEntry(method, stateVar){
    const id = cssId(method);
    const inp = document.getElementById(`pay-input-${id}`);
    const cur = document.getElementById(`pay-current-${id}`);
    const raw = inp.value.trim();
    
    if(!raw) return;
    
    let val;
    try{ 
        val = evaluateExpression(raw); 
    } catch { 
        alert('Expressão inválida. Use apenas números e operadores + - * / ( )'); 
        inp.focus(); 
        return; 
    }
    
    if(val <= 0) { 
        if(val === 0) {
            inp.value = '';
            cur.textContent = money(0);
        } else {
             alert('Valor precisa ser maior que zero.'); 
             inp.focus();
        }
        return; 
    }
    
    stateVar[method].push({expr: raw, value: val});
    saveState();
    renderEntryList(method, stateVar, (stateVar === payments));
    updateAllTotals();
    
    inp.value = '';
    cur.textContent = money(0);
  }

  // Função que renderiza a lista de lançamentos
  function renderEntryList(method, stateVar, isPayment){
    const id = cssId(method);
    const list = document.getElementById(`pay-list-${id}`);
    list.innerHTML = '';
    const arr = stateVar[method] || [];
    if(arr.length === 0){ list.innerHTML = '<div class="muted">Nenhum lançamento.</div>'; return; }
    
    let total = 0;
    arr.forEach((item, idx) => {
      total += Number(item.value || 0);
      const el = document.createElement('div');
      el.className = 'payment-item';
      el.innerHTML = `<div>${idx+1}. ${item.expr} = **${money(item.value)}**</div> 
                      <div style="display:flex;gap:8px">
                        <button class="small-btn" data-idx="${idx}" data-act="rem" style="background:#fee2e2;border:1px solid #fca5a5">Remover</button>
                        <button class="small-btn" data-idx="${idx}" data-act="edit" style="background:#eef2ff;border:1px solid #cfe3ff">Editar</button>
                      </div>`;
      list.appendChild(el);
    });
    
    // attach listeners
    list.querySelectorAll('button').forEach(b => {
      b.addEventListener('click', e => {
        const i = Number(e.currentTarget.dataset.idx);
        const act = e.currentTarget.dataset.act;
        if(act === 'rem'){
          if(!confirm('Remover item?')) return;
          stateVar[method].splice(i,1);
        } else if(act === 'edit'){
          const old = stateVar[method][i].expr;
          const novo = prompt('Editar expressão:', old);
          if(novo === null) return;
          try{
            const v = evaluateExpression(novo);
            stateVar[method][i] = { expr: novo, value: v };
          } catch { alert('Expressão inválida.'); return; }
        }
        saveState(); renderEntryList(method, stateVar, isPayment); updateAllTotals();
      });
    });

    // atualiza total do método
    const totalEl = document.getElementById(`pay-total-${id}`);
    if(totalEl) totalEl.textContent = money(total);
  }
  
  // Constrói Pagamentos e Retiradas (função corrigida)
  function buildPaymentsAndWithdrawalsUI(){
      // 1. Pagamentos
      paymentsContainer.innerHTML = ''; 
      PAYMENT_METHODS.forEach(method => buildEntryUI(method, paymentsContainer, payments, method, true));
      
      // 2. Retiradas
      withdrawalsContainer.innerHTML = ''; 
      buildEntryUI(WITHDRAWAL_METHOD, withdrawalsContainer, withdrawals, 'Valor Retirado (Motivo/Detalhes)', false);
      
      updateAllTotals();
  }

  // Limpar Pagamentos
  document.getElementById('clearPaymentsBtn').addEventListener('click', ()=>{
    if(!confirm('Apagar TODOS os pagamentos?')) return;
    // Precisa garantir que a nova lista de métodos seja limpa, mas sem perder o registro no objeto payments
    // Simplesmente apagamos todas as entradas no objeto payments para os métodos existentes
    PAYMENT_METHODS.forEach(m => payments[m] = []); 
    
    // NOTA: Se houver métodos antigos no localStorage que não estão em PAYMENT_METHODS, eles ainda estariam lá.
    // Como estamos forçando o init a zerar, não teremos esse problema.
    saveState(); buildPaymentsAndWithdrawalsUI(); updateAllTotals();
  });
  
  // Limpar Retiradas
  clearWithdrawalsBtn.addEventListener('click', ()=>{
    if(!confirm('Apagar TODAS as retiradas de caixa?')) return;
    withdrawals[WITHDRAWAL_METHOD] = [];
    saveState(); buildPaymentsAndWithdrawalsUI(); updateAllTotals();
  });

  // Salva todos os estados
  function saveState(){ 
      localStorage.setItem('payments_v4', JSON.stringify(payments)); 
      localStorage.setItem('cashCounts', JSON.stringify(cashCounts)); 
      localStorage.setItem('withdrawals_v1', JSON.stringify(withdrawals));
  }

  // ===== Relatórios / Export / Impressão (Mantidos) =====
  function generateReport(){
    // caixa
    let billsTotal = 0, coinsTotal = 0;
    const cashDetails = [];
    DENOMINATIONS.forEach(d => {
      const id = cssId(d.value.toFixed(2));
      const raw = document.getElementById(`input-${id}`)?.value || 0;
      const val = parseFloat(raw) || 0;
      let total = 0;
      if(d.isCoin && currentMode === 'weight'){
        const weightValue = d.weight > 0 ? d.weight : 1; 
        const qty = val / weightValue;
        total = qty * d.value;
      } else {
        const qty = Math.round(val);
        total = qty * d.value;
      }
      if(d.isCoin) coinsTotal += total; else billsTotal += total;
      cashDetails.push({name:d.label, input: raw, total});
    });

    // pagamentos
    const payDetails = [];
    let paymentsTotal = 0;
    PAYMENT_METHODS.forEach(m => {
      const arr = payments[m] || [];
      const sum = arr.reduce((s,x)=>s+Number(x.value||0),0);
      paymentsTotal += sum;
      payDetails.push({method:m, items: arr.slice(), total: sum});
    });

    // retiradas
    const withdrawalDetails = [];
    let withdrawalsTotal = (withdrawals[WITHDRAWAL_METHOD] || []).reduce((s,x)=>s + Number(x.value||0),0);
    withdrawalDetails.push({method: WITHDRAWAL_METHOD, items: (withdrawals[WITHDRAWAL_METHOD] || []).slice(), total: withdrawalsTotal});


    const cashTotal = billsTotal + coinsTotal;
    const grandTotal = cashTotal + paymentsTotal; 

    return { cashDetails, billsTotal, coinsTotal, cashTotal, withdrawalsTotal, withdrawalDetails, paymentsTotal, payDetails, grandTotal };
  }

  // Export TXT
  document.getElementById('exportTxtBtn').addEventListener('click', ()=>{
    const r = generateReport();
    let txt = `FECHAMENTO DE CAIXA\n${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}\n`;
    
    // Contagem de Dinheiro
    txt += `\n--- DINHEIRO ---\n`;
    r.cashDetails.forEach(d => {
      if(Number(d.total) > 0) txt += `${d.name} (${d.input}) = ${money(d.total)}\n`;
    });
    txt += `\nTOTAL DINHEIRO: ${money(r.cashTotal)}\n`;
    
    // Pagamentos
    txt += `\n--- PAGAMENTOS ---\n`;
    r.payDetails.forEach(p => {
      if(p.total === 0) return;
      txt += `${p.method}: ${money(p.total)}\n`;
      p.items.forEach((it, idx) => txt += `  -> ${it.expr} = ${money(it.value)}\n`);
    });
    txt += `\nTOTAL PAGAMENTOS: ${money(r.paymentsTotal)}\n`;

    // Retiradas
    txt += `\n--- RETIRADAS ---\n`;
    if(r.withdrawalsTotal > 0){
        r.withdrawalDetails[0].items.forEach((it, idx) => txt += `  -> ${it.expr} = ${money(it.value)}\n`);
    } else {
        txt += 'Nenhuma retirada.\n';
    }
    txt += `TOTAL RETIRADO: ${money(r.withdrawalsTotal)}\n`;
    
    // Total Geral
    txt += `\n----------------\n`;
    txt += `TOTAL CAIXA (Dinheiro + Pagamentos): ${money(r.cashTotal + r.paymentsTotal)}\n`;
    
    const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `fechamento_${new Date().toISOString().slice(0,10)}.txt`; a.click();
  });

  // Export CSV (Mantido)
  document.getElementById('exportCsvBtn').addEventListener('click', ()=>{
    const r = generateReport();
    const lines = ['Tipo;Detalhe;Valor'];
    r.cashDetails.forEach(d => {
      if(Number(d.total) > 0) lines.push(`Dinheiro;"${d.name} (entrada: ${d.input})";"${d.total.toFixed(2).replace('.',',')}"`);
    });
    r.payDetails.forEach(p => {
      p.items.forEach(it => {
        const expr = (it.expr||'').replace(/"/g,'""');
        lines.push(`Pagamento;"${p.method} - ${expr}";"${it.value.toFixed(2).replace('.',',')}"`);
      });
    });
    
    r.withdrawalDetails[0].items.forEach(it => {
        const expr = (it.expr||'').replace(/"/g,'""');
        lines.push(`Retirada;"${WITHDRAWAL_METHOD} - ${expr}";"${(-it.value).toFixed(2).replace('.',',')}"`);
    });
    
    lines.push(`TOTAL DINHEIRO EM CAIXA;;"${r.cashTotal.toFixed(2).replace('.',',')}"`);
    lines.push(`TOTAL PAGAMENTOS;;"${r.paymentsTotal.toFixed(2).replace('.',',')}"`);
    lines.push(`TOTAL RETIRADO;;"${r.withdrawalsTotal.toFixed(2).replace('.',',')}"`);
    
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `fechamento_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  });

  // Impressão (Otimizada para economizar papel)
  document.getElementById('printBtn').addEventListener('click', ()=>{
    const r = generateReport();
    
    // Conteúdo formatado para impressão térmica compacta
    let printContent = ''; 
    
    // Título e Data/Hora
    printContent += `FECHAMENTO DE CAIXA\n`;
    printContent += `${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}\n`;
    printContent += `----------------\n`;
    
    // CONTAGEM DE DINHEIRO
    printContent += `DINHEIRO (QTD/PESO) | TOTAL\n`;
    let foundCash = false;
    r.cashDetails.forEach(d => {
      if(Number(d.total) > 0) {
          // Compactação: nome (input) = valor
          printContent += `${d.name.padEnd(14).slice(0,14)} (${String(d.input).padStart(4)}) ${money(d.total).padStart(10)}\n`;
          foundCash = true;
      }
    });
    if(!foundCash) printContent += `Nenhuma contagem de dinheiro.\n`;
    printContent += `TOTAL DINHEIRO: ${money(r.cashTotal)}\n`;
    printContent += `----------------\n`;

    // PAGAMENTOS (NÃO-DINHEIRO)
    printContent += `PAGAMENTOS\n`;
    let foundPayments = false;
    r.payDetails.forEach(p => {
      if(p.total > 0) {
        // Cabeçalho do método + Total
        printContent += `${p.method.toUpperCase().slice(0,20)}: ${money(p.total)}\n`;
        // Detalhes da entrada (apenas a expressão e valor)
        p.items.forEach((it, idx) => printContent += `  > ${it.expr} = ${money(it.value)}\n`);
        foundPayments = true;
      }
    });
    if(!foundPayments) printContent += `Nenhum pagamento registrado.\n`;
    printContent += `TOTAL PAGAMENTOS: ${money(r.paymentsTotal)}\n`;
    printContent += `----------------\n`;

    // RETIRADA
    printContent += `RETIRADA DE CAIXA\n`;
    if(r.withdrawalsTotal > 0){
        r.withdrawalDetails[0].items.forEach((it, idx) => printContent += `  > ${it.expr} = ${money(it.value)}\n`);
    } else {
        printContent += `Nenhuma retirada registrada.\n`;
    }
    printContent += `TOTAL RETIRADO: ${money(r.withdrawalsTotal)}\n`;
    printContent += `----------------\n`;

    // TOTAIS FINAIS
    printContent += `TOTAL CAIXA (Dinheiro + Pagamentos):\n`;
    printContent += `${money(r.cashTotal + r.paymentsTotal)}\n`;
    printContent += `----------------\n`;

    // Prepara o HTML da janela de impressão
    const outHtml = '<pre style="font-family:monospace; color: black; line-height: 1.2;">' + printContent + '</pre>';
    
    const w = window.open('','_blank','width=400,height=600');
    // CSS para zerar margens e garantir a impressão em preto (evitar dark mode/economia de tinta)
    w.document.write(`
      <html>
      <head>
        <title>Relatório de Caixa</title>
        <style>
          @media print { 
            body { 
              color: black !important; 
              background-color: white !important; 
              -webkit-print-color-adjust: exact; 
              print-color-adjust: exact; 
              /* Zera as margens da página */
              margin: 0; 
              padding: 0;
              /* Define um tamanho de fonte menor para economia */
              font-size: 10pt;
            } 
            pre { 
              color: black !important; 
              margin: 0; /* Zera margem do PRE */
              padding: 0;
            } 
          }
        </style>
      </head>
      <body>
      ${outHtml}
      </body>
      </html>
    `);
    w.document.close(); 
    w.print();
  });

  // AÇÕES DE INICIALIZAÇÃO
  function init(){
    // Força o estado a zerar no carregamento (IGNORANDO DADOS DO LOCALSTORAGE)
    
    // 1. Zera contadores de dinheiro
    cashCounts = {}; 
    
    // 2. Zera pagamentos e retiradas
    payments = {};
    withdrawals = {};
    // Cria entradas vazias para todos os novos métodos, incluindo os novos
    PAYMENT_METHODS.forEach(m => { payments[m] = []; });
    withdrawals[WITHDRAWAL_METHOD] = [];
    
    // 3. Mantém o modo como estava (ou define como 'quantity')
    currentMode = localStorage.getItem('cashCounterMode') || 'quantity'; 
    
    // 4. Renderiza a UI com os dados zerados
    renderDenominations();
    buildPaymentsAndWithdrawalsUI();
    updateAllTotals();
  }

  // salvar pagamentos e retiradas antes de sair
  window.addEventListener('beforeunload', saveState);

  // Inicia a aplicação, forçando a ser zerada.
  init();

});
</script>
</body>
</html>
